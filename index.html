<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audio Transcriber</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #111318;
    --surface: #191c24;
    --surface-raised: #1f2330;
    --border: #2a2f3e;
    --border-focus: #4a7cff;
    --text: #dfe2ed;
    --text-2: #959bb3;
    --text-3: #636a84;
    --blue: #4a7cff;
    --blue-dim: rgba(74, 124, 255, 0.12);
    --green: #34c77b;
    --green-dim: rgba(52, 199, 123, 0.12);
    --amber: #e8a630;
    --amber-dim: rgba(232, 166, 48, 0.12);
    --red: #ef5656;
    --red-dim: rgba(239, 86, 86, 0.12);
    --radius: 8px;
    --radius-lg: 12px;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 2rem 1.5rem;
  }

  .app { max-width: 820px; margin: 0 auto; }

  /* â”€â”€ Header â”€â”€ */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-weight: 700;
    font-size: 1.15rem;
    letter-spacing: -0.01em;
  }

  .logo-mark {
    width: 32px; height: 32px;
    background: var(--blue);
    border-radius: 8px;
    display: grid;
    place-items: center;
    font-size: 0.9rem;
  }

  .gear-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-2);
    padding: 0.45rem 0.9rem;
    border-radius: var(--radius);
    cursor: pointer;
    font: 500 0.82rem var(--sans);
    transition: 0.15s;
  }
  .gear-btn:hover { border-color: var(--blue); color: var(--text); }

  /* â”€â”€ Panels â”€â”€ */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.25rem;
  }

  .panel-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-3);
    margin-bottom: 1rem;
  }

  /* â”€â”€ Settings â”€â”€ */
  #settingsPanel { display: none; }
  #settingsPanel.open { display: block; animation: fadeSlide 0.2s ease; }

  @keyframes fadeSlide {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .field { margin-bottom: 1rem; }
  .field:last-child { margin-bottom: 0; }

  .field label {
    display: block;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-2);
    margin-bottom: 0.3rem;
  }

  .field input, .field select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.55rem 0.75rem;
    border-radius: 6px;
    font: 400 0.82rem var(--mono);
    outline: none;
    transition: border-color 0.15s;
  }

  .field input:focus, .field select:focus { border-color: var(--blue); }

  .field .hint {
    font-size: 0.72rem;
    color: var(--text-3);
    margin-top: 0.25rem;
  }

  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

  .save-settings-btn {
    margin-top: 0.5rem;
    padding: 0.5rem 1.2rem;
    background: var(--blue-dim);
    color: var(--blue);
    border: 1px solid transparent;
    border-radius: var(--radius);
    font: 600 0.82rem var(--sans);
    cursor: pointer;
    transition: 0.15s;
  }
  .save-settings-btn:hover { background: var(--blue); color: #fff; }

  /* â”€â”€ Drop Zone â”€â”€ */
  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius-lg);
    padding: 2.5rem 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: 0.2s;
    background: var(--surface);
  }

  .drop-zone:hover, .drop-zone.over {
    border-color: var(--blue);
    background: var(--blue-dim);
  }

  .drop-zone .icon { font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; }

  .drop-zone p { color: var(--text-2); font-size: 0.9rem; }
  .drop-zone p strong { color: var(--blue); }

  .drop-zone .formats {
    font-size: 0.72rem;
    color: var(--text-3);
    margin-top: 0.4rem;
    font-family: var(--mono);
  }

  input[type="file"] { display: none; }

  /* â”€â”€ File Badge â”€â”€ */
  .file-badge {
    display: none;
    align-items: center;
    gap: 0.8rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.8rem 1rem;
    margin-top: 1rem;
  }

  .file-badge.show { display: flex; }

  .file-badge .info { flex: 1; }

  .file-badge .name {
    font-weight: 600;
    font-size: 0.88rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 500px;
  }

  .file-badge .meta {
    font: 400 0.75rem var(--mono);
    color: var(--text-2);
    margin-top: 0.1rem;
  }

  .file-badge .remove {
    background: none;
    border: none;
    color: var(--text-3);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    transition: 0.15s;
  }
  .file-badge .remove:hover { color: var(--red); background: var(--red-dim); }

  /* â”€â”€ Primary Button â”€â”€ */
  .btn-primary {
    width: 100%;
    margin-top: 1rem;
    padding: 0.8rem;
    background: var(--blue);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    font: 700 0.9rem var(--sans);
    cursor: pointer;
    transition: 0.15s;
    letter-spacing: 0.01em;
  }

  .btn-primary:hover:not(:disabled) { filter: brightness(1.12); transform: translateY(-1px); }
  .btn-primary:disabled { opacity: 0.35; cursor: not-allowed; }

  /* â”€â”€ Progress â”€â”€ */
  .progress { display: none; margin-top: 1.25rem; }
  .progress.show { display: block; }

  .progress-track {
    width: 100%;
    height: 5px;
    background: var(--surface-raised);
    border-radius: 3px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    width: 0%;
    background: var(--blue);
    border-radius: 3px;
    transition: width 0.35s ease;
  }

  .progress-label {
    font: 400 0.78rem var(--mono);
    color: var(--text-2);
    margin-top: 0.4rem;
  }

  /* â”€â”€ Editor â”€â”€ */
  .editor { display: none; margin-top: 1.75rem; }
  .editor.show { display: block; animation: fadeSlide 0.3s ease; }

  .editor-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.6rem;
  }

  .editor-top h2 { font-size: 1rem; font-weight: 600; }

  .wc {
    font: 400 0.75rem var(--mono);
    color: var(--text-3);
  }

  .editor textarea {
    width: 100%;
    min-height: 280px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 1.1rem;
    border-radius: var(--radius-lg);
    font: 400 0.9rem var(--sans);
    line-height: 1.75;
    resize: vertical;
    outline: none;
    transition: border-color 0.15s;
  }

  .editor textarea:focus { border-color: var(--blue); }

  /* â”€â”€ Save Actions â”€â”€ */
  .save-row {
    margin-top: 1rem;
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
  }

  .save-target {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    min-width: 260px;
  }

  .save-target select {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.55rem 0.75rem;
    border-radius: 6px;
    font: 400 0.82rem var(--sans);
    outline: none;
  }

  .save-target select:focus { border-color: var(--blue); }

  .btn-green {
    padding: 0.6rem 1.1rem;
    background: var(--green);
    color: #111;
    border: none;
    border-radius: var(--radius);
    font: 600 0.82rem var(--sans);
    cursor: pointer;
    transition: 0.15s;
    white-space: nowrap;
  }
  .btn-green:hover:not(:disabled) { filter: brightness(1.1); }
  .btn-green:disabled { opacity: 0.35; cursor: not-allowed; }

  .btn-outline {
    padding: 0.6rem 1rem;
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font: 500 0.82rem var(--sans);
    cursor: pointer;
    transition: 0.15s;
    white-space: nowrap;
  }
  .btn-outline:hover { border-color: var(--blue); }

  .btn-sm-icon {
    padding: 0.55rem 0.7rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text-2);
    cursor: pointer;
    font-size: 0.9rem;
    transition: 0.15s;
  }
  .btn-sm-icon:hover { border-color: var(--blue); color: var(--text); }

  .action-row {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.6rem;
    justify-content: flex-end;
  }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface-raised);
    border: 1px solid var(--border);
    padding: 0.7rem 1.4rem;
    border-radius: var(--radius);
    font: 500 0.85rem var(--sans);
    opacity: 0;
    transition: 0.25s ease;
    z-index: 100;
    white-space: nowrap;
    pointer-events: none;
  }

  .toast.on {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .toast.ok { border-color: var(--green); color: var(--green); }
  .toast.err { border-color: var(--red); color: var(--red); }
  .toast.warn { border-color: var(--amber); color: var(--amber); }

  /* â”€â”€ Responsive â”€â”€ */
  @media (max-width: 600px) {
    body { padding: 1rem; }
    .two-col { grid-template-columns: 1fr; }
    .save-row { flex-direction: column; }
    .save-target { min-width: 100%; }
  }
</style>
</head>
<body>
<div class="app">

  <!-- Top Bar -->
  <div class="top-bar">
    <div class="logo">
      <div class="logo-mark">ðŸŽ™</div>
      <span>Transcriber</span>
    </div>
    <button class="gear-btn" onclick="toggleSettings()">âš™ Settings</button>
  </div>

  <!-- Settings -->
  <div class="panel" id="settingsPanel">
    <div class="panel-title">Configuration</div>

    <div class="field">
      <label>OpenAI API Key</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
      <div class="hint">Used client-side for Whisper transcription. Never sent to the Apps Script.</div>
    </div>

    <div class="two-col">
      <div class="field">
        <label>Whisper Model</label>
        <select id="whisperModel">
          <option value="whisper-1">whisper-1</option>
        </select>
      </div>
      <div class="field">
        <label>Language (optional)</label>
        <input type="text" id="lang" placeholder="en, es, fr..." />
        <div class="hint">ISO 639-1 code. Blank = auto.</div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:1.2rem 0;">

    <div class="field">
      <label>Apps Script Web App URL</label>
      <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec" />
      <div class="hint">Deploy your Apps Script as a web app and paste the URL here.</div>
    </div>

    <div class="field">
      <label>Google Drive Folder ID</label>
      <input type="text" id="folderId" placeholder="1aBcDeFgHiJkLmNoPqRsTuVwXyZ" />
      <div class="hint">From the folder URL: drive.google.com/drive/folders/<strong>[THIS_ID]</strong>. Used for new docs &amp; doc listing.</div>
    </div>

    <button class="save-settings-btn" onclick="saveSettings()">Save &amp; Load Docs</button>
  </div>

  <!-- Upload -->
  <div class="drop-zone" id="dropZone" onclick="$('fileInput').click()">
    <div class="icon">ðŸ“‚</div>
    <p>Drop audio file or <strong>browse</strong></p>
    <div class="formats">mp3 Â· wav Â· m4a Â· flac Â· ogg Â· webm Â· mp4</div>
  </div>
  <input type="file" id="fileInput" accept="audio/*,video/mp4,.mp3,.wav,.m4a,.flac,.ogg,.webm,.mp4" />

  <div class="file-badge" id="fileBadge">
    <span style="font-size:1.3rem">ðŸŽµ</span>
    <div class="info">
      <div class="name" id="fileName"></div>
      <div class="meta" id="fileMeta"></div>
    </div>
    <button class="remove" onclick="clearFile()" title="Remove">&times;</button>
  </div>

  <button class="btn-primary" id="goBtn" disabled onclick="transcribe()">Transcribe</button>

  <!-- Progress -->
  <div class="progress" id="prog">
    <div class="progress-track"><div class="progress-fill" id="progFill"></div></div>
    <div class="progress-label" id="progLabel">Preparing...</div>
  </div>

  <!-- Editor + Save -->
  <div class="editor" id="editorWrap">
    <div class="editor-top">
      <h2>Transcript</h2>
      <span class="wc" id="wc">0 words</span>
    </div>
    <textarea id="editor" oninput="countWords()"></textarea>

    <!-- Save to Drive -->
    <div class="save-row">
      <div class="save-target">
        <select id="docTarget">
          <option value="__new__">ï¼‹ Create new Google Doc</option>
        </select>
        <button class="btn-sm-icon" onclick="refreshDocList()" title="Refresh doc list">â†»</button>
      </div>
      <button class="btn-green" id="saveBtn" onclick="saveToDrive()">Save to Drive</button>
    </div>
    <div class="action-row">
      <button class="btn-outline" onclick="copyText()">ðŸ“‹ Copy</button>
      <button class="btn-outline" onclick="downloadTxt()">â¬‡ Download .txt</button>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
const $ = id => document.getElementById(id);
const CHUNK_MAX = 24 * 1024 * 1024; // 24 MB â€” under Whisper's 25 MB limit
let file = null;

// â”€â”€ Settings â”€â”€
const KEYS = ['apiKey', 'lang', 'scriptUrl', 'folderId'];

function loadSettings() {
  KEYS.forEach(k => {
    const v = localStorage.getItem('t_' + k);
    if (v) $(k).value = v;
  });
}

function saveSettings() {
  KEYS.forEach(k => localStorage.setItem('t_' + k, $(k).value.trim()));
  toast('Settings saved', 'ok');
  refreshDocList();
}

function toggleSettings() {
  $('settingsPanel').classList.toggle('open');
}

// â”€â”€ File Handling â”€â”€
const dz = $('dropZone');

dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('over'); if (e.dataTransfer.files.length) pick(e.dataTransfer.files[0]); });
$('fileInput').addEventListener('change', e => { if (e.target.files.length) pick(e.target.files[0]); });

function pick(f) {
  file = f;
  const mb = (f.size / 1048576).toFixed(1);
  $('fileName').textContent = f.name;
  let meta = mb + ' MB';
  if (f.size > CHUNK_MAX) {
    meta += ' Â· ' + Math.ceil(f.size / CHUNK_MAX) + ' chunks';
  }
  $('fileMeta').textContent = meta;
  $('fileBadge').classList.add('show');
  $('goBtn').disabled = false;
}

function clearFile() {
  file = null;
  $('fileInput').value = '';
  $('fileBadge').classList.remove('show');
  $('goBtn').disabled = true;
}

// â”€â”€ Transcription â”€â”€
async function transcribe() {
  const key = $('apiKey').value.trim();
  if (!key) { toast('Add your OpenAI API key in Settings', 'err'); toggleSettings(); return; }
  if (!file) return;

  $('goBtn').disabled = true;
  $('goBtn').textContent = 'Transcribingâ€¦';
  $('prog').classList.add('show');

  try {
    let transcript = '';

    if (file.size <= CHUNK_MAX) {
      prog(10, 'Sending to Whisperâ€¦');
      transcript = await whisper(file, key);
      prog(100, 'Done');
    } else {
      const n = Math.ceil(file.size / CHUNK_MAX);
      for (let i = 0; i < n; i++) {
        const blob = file.slice(i * CHUNK_MAX, Math.min((i + 1) * CHUNK_MAX, file.size));
        const ext = file.name.split('.').pop() || 'mp3';
        const chunk = new File([blob], `part${i}.${ext}`, { type: file.type });

        prog(Math.round((i / n) * 100), `Chunk ${i + 1}/${n} (${(blob.size / 1048576).toFixed(1)} MB)â€¦`);
        const t = await whisper(chunk, key, i > 0);
        transcript += (transcript ? ' ' : '') + t;
      }
      prog(100, `All ${n} chunks done`);
    }

    $('editor').value = transcript;
    $('editorWrap').classList.add('show');
    countWords();
    toast('Transcription complete', 'ok');
  } catch (err) {
    console.error(err);
    toast(err.message, 'err');
  } finally {
    $('goBtn').disabled = false;
    $('goBtn').textContent = 'Transcribe';
  }
}

async function whisper(f, key, isContinuation) {
  const fd = new FormData();
  fd.append('file', f);
  fd.append('model', $('whisperModel').value);
  fd.append('response_format', 'text');
  const lang = $('lang').value.trim();
  if (lang) fd.append('language', lang);
  if (isContinuation) fd.append('prompt', '...');

  const res = await fetch('https://api.openai.com/v1/audio/transcriptions', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + key },
    body: fd
  });

  if (!res.ok) {
    const e = await res.text();
    throw new Error('Whisper ' + res.status + ': ' + e.slice(0, 200));
  }
  return (await res.text()).trim();
}

function prog(pct, msg) {
  $('progFill').style.width = pct + '%';
  $('progLabel').textContent = msg;
}

// â”€â”€ Editor Utilities â”€â”€
function countWords() {
  const t = $('editor').value.trim();
  $('wc').textContent = (t ? t.split(/\s+/).length : 0).toLocaleString() + ' words';
}

function copyText() {
  navigator.clipboard.writeText($('editor').value);
  toast('Copied', 'ok');
}

function downloadTxt() {
  const name = file ? file.name.replace(/\.[^.]+$/, '') + '_transcript.txt' : 'transcript.txt';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([$('editor').value], { type: 'text/plain' }));
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Downloaded', 'ok');
}

// â”€â”€ Google Drive via Apps Script â”€â”€
async function callScript(payload) {
  const url = $('scriptUrl').value.trim();
  if (!url) throw new Error('Set your Apps Script URL in Settings');

  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },  // avoid CORS preflight
    body: JSON.stringify(payload)
  });

  // Apps Script web apps redirect â€” fetch follows automatically
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data;
}

async function refreshDocList() {
  const fid = $('folderId').value.trim();
  if (!fid) return;

  const sel = $('docTarget');
  // Keep the "new" option
  sel.innerHTML = '<option value="__new__">ï¼‹ Create new Google Doc</option>';

  try {
    const data = await callScript({ action: 'listDocs', folderId: fid });
    if (data.docs) {
      data.docs.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.name;
        sel.appendChild(opt);
      });
      toast(data.docs.length + ' docs loaded from ' + data.folderName, 'ok');
    }
  } catch (err) {
    console.error(err);
    toast('Could not list docs: ' + err.message, 'err');
  }
}

async function saveToDrive() {
  const text = $('editor').value;
  if (!text.trim()) { toast('Nothing to save', 'warn'); return; }

  const target = $('docTarget').value;
  const fid = $('folderId').value.trim();
  const btn = $('saveBtn');
  btn.disabled = true;
  btn.textContent = 'Savingâ€¦';

  try {
    let result;

    if (target === '__new__') {
      const name = file
        ? file.name.replace(/\.[^.]+$/, '') + ' â€” Transcript'
        : 'Transcript ' + new Date().toISOString().slice(0, 16);
      result = await callScript({ action: 'create', text, fileName: name, folderId: fid });
      toast('Created: ' + result.name, 'ok');

      // Add the new doc to the dropdown and select it
      if (result.docId) {
        const opt = document.createElement('option');
        opt.value = result.docId;
        opt.textContent = result.name;
        $('docTarget').insertBefore(opt, $('docTarget').children[1]);
        $('docTarget').value = result.docId;
      }
    } else {
      result = await callScript({ action: 'update', text, docId: target });
      toast('Updated: ' + result.name, 'ok');
    }

    // Open the doc in a new tab
    if (result.docUrl) window.open(result.docUrl, '_blank');

  } catch (err) {
    console.error(err);
    toast('Save failed: ' + err.message, 'err');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save to Drive';
  }
}

// â”€â”€ Toast â”€â”€
let toastTimer;
function toast(msg, type = '') {
  const el = $('toast');
  clearTimeout(toastTimer);
  el.textContent = msg;
  el.className = 'toast ' + type;
  requestAnimationFrame(() => el.classList.add('on'));
  toastTimer = setTimeout(() => el.classList.remove('on'), 3500);
}

// â”€â”€ Init â”€â”€
loadSettings();
// Auto-load doc list if settings are present
window.addEventListener('load', () => {
  if ($('scriptUrl').value.trim() && $('folderId').value.trim()) {
    setTimeout(refreshDocList, 500);
  }
});
</script>
</body>
</html>
